name: Build and Test Linux/Mac Apps

on:
  push:
    branches: [ main, develop, 'claude/**' ]
  pull_request:
    branches: [ main, develop ]

jobs:
  build-linux:
    name: Build Linux App
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Qt6
      run: |
        sudo apt-get update
        sudo apt-get install -y qt6-base-dev qt6-tools-dev cmake build-essential

    - name: Configure CMake
      working-directory: linux/DivitageLinuxApp
      run: cmake -S . -B build -DCMAKE_BUILD_TYPE=Release

    - name: Build
      working-directory: linux/DivitageLinuxApp
      run: cmake --build build --config Release

    - name: Run tests
      working-directory: linux/DivitageLinuxApp
      run: |
        if [ -d "build/tests" ]; then
          cd build/tests
          ctest --output-on-failure
        else
          echo "No tests found - skipping test execution"
        fi

    - name: Upload Linux artifact
      uses: actions/upload-artifact@v4
      with:
        name: DivitageLinuxApp
        path: linux/DivitageLinuxApp/build/DivitageLinuxApp

  build-mac:
    name: Build Mac App
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Swift
      uses: swift-actions/setup-swift@v2
      with:
        swift-version: '5.9'

    - name: Build
      working-directory: mac/DivitageMacApp
      run: swift build -c release

    - name: Run tests
      working-directory: mac/DivitageMacApp
      run: swift test

    - name: Upload Mac artifact
      uses: actions/upload-artifact@v4
      with:
        name: DivitageMacApp
        path: mac/DivitageMacApp/.build/release/DivitageMacApp
